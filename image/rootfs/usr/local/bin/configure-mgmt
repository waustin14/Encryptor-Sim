#!/bin/sh
# configure-mgmt - Serial console script for MGMT interface configuration
#
# This script allows administrators to configure the MGMT interface (eth0)
# via serial console when DHCP is unavailable. Configuration persists
# across reboots.
#
# Usage: Run from serial console: configure-mgmt
#
# Configuration files:
#   /etc/encryptor/network-config - Mode flag (dhcp or static)
#   /etc/network/interfaces.d/mgmt - Static IP configuration
#
# Part of Story 2.4: Serial Console MGMT Configuration

set -e

# Configuration paths
ROOT_PREFIX="${CONFIGURE_MGMT_ROOT:-}"
NETWORK_CONFIG="${ROOT_PREFIX}/etc/encryptor/network-config"
INTERFACES_FILE="${ROOT_PREFIX}/etc/network/interfaces.d/mgmt"
NAMESPACE="ns_mgmt"
INTERFACE="eth0"

# Colors for terminal output (if supported)
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log_info() {
    echo "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo "${RED}[ERROR]${NC} $1"
}

log_cmd() {
    if [ -n "${CONFIGURE_MGMT_CMD_LOG:-}" ]; then
        printf "%s\n" "$*" >> "$CONFIGURE_MGMT_CMD_LOG"
    fi
}

netns_exec() {
    log_cmd "ip netns exec $NAMESPACE $*"
    if [ "${CONFIGURE_MGMT_SKIP_NETNS:-0}" = "1" ]; then
        return 0
    fi
    ip netns exec "$NAMESPACE" "$@"
}

stop_dhcp_client() {
    log_info "Stopping DHCP client (if running)..."
    netns_exec sh -c "killall udhcpc >/dev/null 2>&1 || true"
}

# Validate IPv4 address format
# Args: $1 = IP address string
# Returns: 0 if valid, 1 if invalid
validate_ip() {
    local ip="$1"

    # Check basic format: x.x.x.x where x is 1-3 digits
    if ! echo "$ip" | grep -Eq '^([0-9]{1,3}\.){3}[0-9]{1,3}$'; then
        return 1
    fi

    # Check each octet is 0-255
    local IFS='.'
    set -- $ip
    for octet in "$1" "$2" "$3" "$4"; do
        if [ "$octet" -gt 255 ] 2>/dev/null; then
            return 1
        fi
        # Handle non-numeric values
        if ! [ "$octet" -eq "$octet" ] 2>/dev/null; then
            return 1
        fi
    done

    return 0
}

# Validate netmask format (must be valid subnet mask)
# Args: $1 = netmask string
# Returns: 0 if valid, 1 if invalid
validate_netmask() {
    local netmask="$1"

    # First check IP format
    if ! validate_ip "$netmask"; then
        return 1
    fi

    # Common valid netmasks
    case "$netmask" in
        255.255.255.255|255.255.255.254|255.255.255.252|255.255.255.248)
            return 0 ;;
        255.255.255.240|255.255.255.224|255.255.255.192|255.255.255.128)
            return 0 ;;
        255.255.255.0|255.255.254.0|255.255.252.0|255.255.248.0)
            return 0 ;;
        255.255.240.0|255.255.224.0|255.255.192.0|255.255.128.0)
            return 0 ;;
        255.255.0.0|255.254.0.0|255.252.0.0|255.248.0.0)
            return 0 ;;
        255.240.0.0|255.224.0.0|255.192.0.0|255.128.0.0)
            return 0 ;;
        255.0.0.0|254.0.0.0|252.0.0.0|248.0.0.0)
            return 0 ;;
        240.0.0.0|224.0.0.0|192.0.0.0|128.0.0.0)
            return 0 ;;
        0.0.0.0)
            return 0 ;;
        *)
            return 1 ;;
    esac
}

# Get current configuration mode
get_current_mode() {
    if [ -f "$NETWORK_CONFIG" ]; then
        grep '^mode=' "$NETWORK_CONFIG" 2>/dev/null | cut -d= -f2 || echo "dhcp"
    else
        echo "dhcp"
    fi
}

# Get current IP address from interface
get_current_ip() {
    if [ "${CONFIGURE_MGMT_SKIP_NETNS:-0}" = "1" ]; then
        echo "none"
        return 0
    fi
    ip netns exec "$NAMESPACE" ip -4 addr show "$INTERFACE" 2>/dev/null | \
        grep 'inet ' | awk '{print $2}' | cut -d/ -f1 || echo "none"
}

# Display the main menu
show_menu() {
    clear
    echo "=========================================="
    echo "   MGMT Interface Configuration"
    echo "   Encryptor Simulator"
    echo "=========================================="
    echo ""
    echo "Current Mode: $(get_current_mode)"
    echo "Current IP:   $(get_current_ip)"
    echo ""
    echo "Options:"
    echo "  1. Configure Static IP"
    echo "  2. Revert to DHCP"
    echo "  3. Show Current Configuration"
    echo "  4. Exit"
    echo ""
    printf "Select option [1-4]: "
}

# Configure static IP
configure_static() {
    echo ""
    echo "=========================================="
    echo "   Static IP Configuration"
    echo "=========================================="
    echo ""

    # Prompt for IP address
    while true; do
        printf "Enter IP Address: "
        read -r ip_addr
        if validate_ip "$ip_addr"; then
            break
        else
            log_error "Invalid IP address format. Please use format: x.x.x.x (e.g., 192.168.1.100)"
        fi
    done

    # Prompt for netmask
    while true; do
        printf "Enter Netmask (e.g., 255.255.255.0): "
        read -r netmask
        if validate_netmask "$netmask"; then
            break
        else
            log_error "Invalid netmask. Please use a valid subnet mask (e.g., 255.255.255.0)"
        fi
    done

    # Prompt for gateway
    while true; do
        printf "Enter Gateway: "
        read -r gateway
        if validate_ip "$gateway"; then
            break
        else
            log_error "Invalid gateway address format. Please use format: x.x.x.x"
        fi
    done

    echo ""
    echo "Configuration Summary:"
    echo "  IP Address: $ip_addr"
    echo "  Netmask:    $netmask"
    echo "  Gateway:    $gateway"
    echo ""
    if [ "${CONFIGURE_MGMT_NONINTERACTIVE:-0}" = "1" ]; then
        confirm="y"
    else
        printf "Apply this configuration? [y/N]: "
        read -r confirm
    fi

    case "$confirm" in
        [Yy]|[Yy][Ee][Ss])
            apply_static_config "$ip_addr" "$netmask" "$gateway"
            ;;
        *)
            log_warn "Configuration cancelled"
            ;;
    esac

    if [ "${CONFIGURE_MGMT_NONINTERACTIVE:-0}" != "1" ]; then
        echo ""
        printf "Press Enter to continue..."
        read -r _
    fi
}

# Apply static configuration
apply_static_config() {
    local ip_addr="$1"
    local netmask="$2"
    local gateway="$3"
    local apply_failed=0

    log_info "Creating configuration directories..."
    mkdir -p "${ROOT_PREFIX}/etc/network/interfaces.d"
    mkdir -p "${ROOT_PREFIX}/etc/encryptor"

    log_info "Writing interfaces configuration..."
    cat > "$INTERFACES_FILE" <<EOF
# MGMT interface static configuration
# Generated by configure-mgmt on $(date)
# Do not edit manually - use configure-mgmt script
auto $INTERFACE
iface $INTERFACE inet static
    address $ip_addr
    netmask $netmask
    gateway $gateway
EOF

    log_info "Setting network mode to static..."
    cat > "$NETWORK_CONFIG" <<EOF
# Network configuration mode for MGMT interface
# Generated by configure-mgmt on $(date)
# Values: dhcp | static
mode=static
EOF

    log_info "Applying configuration to interface..."

    stop_dhcp_client

    # Bring interface down first
    netns_exec ip addr flush dev "$INTERFACE" 2>/dev/null || true

    # Apply static configuration using ifup
    if command -v ifup >/dev/null 2>&1; then
        netns_exec ifup "$INTERFACE" -i "$INTERFACES_FILE" 2>/dev/null || {
            apply_failed=1
            log_warn "ifup failed, applying configuration manually..."
        }
    else
        apply_failed=1
    fi

    if [ "$apply_failed" -ne 0 ]; then
        netns_exec ip addr add "$ip_addr/$(netmask_to_cidr "$netmask")" dev "$INTERFACE" 2>/dev/null || apply_failed=1
        netns_exec ip route add default via "$gateway" 2>/dev/null || true
    fi

    # Verify configuration
    local new_ip
    new_ip=$(get_current_ip)
    if [ "${CONFIGURE_MGMT_SKIP_NETNS:-0}" = "1" ]; then
        log_info "Static configuration written successfully (network apply skipped)"
        return 0
    fi
    if [ "$new_ip" = "$ip_addr" ]; then
        log_info "Static configuration applied successfully!"
        log_info "Configuration will persist across reboots."
    else
        log_warn "Configuration may not have been applied correctly."
        log_warn "Current IP: $new_ip (expected: $ip_addr)"
        log_warn "Falling back to DHCP to avoid leaving interface down"
        cat > "$NETWORK_CONFIG" <<EOF
# Network configuration mode for MGMT interface
# Generated by configure-mgmt on $(date)
# Values: dhcp | static
mode=dhcp
EOF
        netns_exec udhcpc -i "$INTERFACE" -f -q 2>/dev/null || true
    fi
}

# Convert netmask to CIDR notation
netmask_to_cidr() {
    local netmask="$1"
    local cidr=0

    local IFS='.'
    set -- $netmask
    for octet in "$1" "$2" "$3" "$4"; do
        case "$octet" in
            255) cidr=$((cidr + 8)) ;;
            254) cidr=$((cidr + 7)) ;;
            252) cidr=$((cidr + 6)) ;;
            248) cidr=$((cidr + 5)) ;;
            240) cidr=$((cidr + 4)) ;;
            224) cidr=$((cidr + 3)) ;;
            192) cidr=$((cidr + 2)) ;;
            128) cidr=$((cidr + 1)) ;;
            0) ;;
        esac
    done

    echo "$cidr"
}

# Revert to DHCP
revert_to_dhcp() {
    echo ""
    echo "=========================================="
    echo "   Revert to DHCP"
    echo "=========================================="
    echo ""

    if [ "${CONFIGURE_MGMT_NONINTERACTIVE:-0}" = "1" ]; then
        confirm="y"
    else
        printf "Revert to DHCP configuration? [y/N]: "
        read -r confirm
    fi

    case "$confirm" in
        [Yy]|[Yy][Ee][Ss])
            log_info "Reverting to DHCP..."

            # Remove static configuration file
            if [ -f "$INTERFACES_FILE" ]; then
                rm -f "$INTERFACES_FILE"
                log_info "Removed static configuration file"
            fi

            # Set mode to dhcp
            mkdir -p "${ROOT_PREFIX}/etc/encryptor"
            cat > "$NETWORK_CONFIG" <<EOF
# Network configuration mode for MGMT interface
# Generated by configure-mgmt on $(date)
# Values: dhcp | static
mode=dhcp
EOF
            log_info "Set network mode to dhcp"

            # Bring interface down and flush addresses
            netns_exec ip addr flush dev "$INTERFACE" 2>/dev/null || true

            # Run DHCP client
            log_info "Starting DHCP client..."
            if [ "${CONFIGURE_MGMT_ASSUME_UDHCPC:-0}" = "1" ] || command -v udhcpc >/dev/null 2>&1; then
                netns_exec udhcpc -i "$INTERFACE" -f -q 2>/dev/null || {
                    log_warn "DHCP client returned non-zero, lease may not have been obtained"
                }
            else
                log_error "udhcpc not found - cannot start DHCP client"
            fi

            # Verify DHCP
            sleep 2
            local new_ip
            new_ip=$(get_current_ip)
            if [ "$new_ip" != "none" ] && [ -n "$new_ip" ]; then
                log_info "DHCP lease obtained: $new_ip"
            else
                log_warn "No DHCP lease obtained yet"
            fi

            log_info "Reverted to DHCP mode successfully!"
            log_info "Configuration will persist across reboots."
            ;;
        *)
            log_warn "DHCP revert cancelled"
            ;;
    esac

    if [ "${CONFIGURE_MGMT_NONINTERACTIVE:-0}" != "1" ]; then
        echo ""
        printf "Press Enter to continue..."
        read -r _
    fi
}

# Show current configuration
show_current_config() {
    echo ""
    echo "=========================================="
    echo "   Current MGMT Configuration"
    echo "=========================================="
    echo ""

    local mode
    mode=$(get_current_mode)
    echo "Configuration Mode: $mode"
    echo ""

    if [ -f "$NETWORK_CONFIG" ]; then
        echo "Mode Configuration File ($NETWORK_CONFIG):"
        cat "$NETWORK_CONFIG"
        echo ""
    else
        echo "Mode Configuration File: Not present (using default: dhcp)"
        echo ""
    fi

    if [ -f "$INTERFACES_FILE" ]; then
        echo "Static Interfaces File ($INTERFACES_FILE):"
        cat "$INTERFACES_FILE"
        echo ""
    else
        echo "Static Interfaces File: Not present"
        echo ""
    fi

    echo "Current Interface Status:"
    ip netns exec "$NAMESPACE" ip addr show "$INTERFACE" 2>/dev/null || echo "  Interface not available"
    echo ""

    echo "Current Routing Table:"
    ip netns exec "$NAMESPACE" ip route show 2>/dev/null || echo "  Routes not available"
    echo ""

    if [ "${CONFIGURE_MGMT_NONINTERACTIVE:-0}" != "1" ]; then
        printf "Press Enter to continue..."
        read -r _
    fi
}

# Main program loop
main() {
    # Check if running as root
    if [ "$(id -u)" -ne 0 ] && [ "${CONFIGURE_MGMT_ALLOW_NONROOT:-0}" != "1" ]; then
        log_error "This script must be run as root"
        exit 1
    fi

    # Check if namespace exists
    if [ "${CONFIGURE_MGMT_SKIP_NETNS:-0}" != "1" ] && ! ip netns list | grep -q "^$NAMESPACE"; then
        log_error "Namespace $NAMESPACE does not exist"
        log_error "Ensure encryptor-namespaces service is running"
        exit 1
    fi

    while true; do
        show_menu
        read -r choice
        case "$choice" in
            1) configure_static ;;
            2) revert_to_dhcp ;;
            3) show_current_config ;;
            4)
                echo ""
                log_info "Exiting..."
                exit 0
                ;;
            *)
                log_error "Invalid option"
                sleep 1
                ;;
        esac
    done
}

# Non-interactive command handling (test automation)
case "${1:-}" in
    --apply-static)
        if [ -z "${2:-}" ] || [ -z "${3:-}" ] || [ -z "${4:-}" ]; then
            log_error "Usage: configure-mgmt --apply-static <ip> <netmask> <gateway>"
            exit 1
        fi
        validate_ip "$2" || { log_error "Invalid IP address format"; exit 1; }
        validate_netmask "$3" || { log_error "Invalid netmask"; exit 1; }
        validate_ip "$4" || { log_error "Invalid gateway format"; exit 1; }
        apply_static_config "$2" "$3" "$4"
        exit 0
        ;;
    --revert-dhcp)
        CONFIGURE_MGMT_NONINTERACTIVE=1 revert_to_dhcp
        exit 0
        ;;
    --show)
        CONFIGURE_MGMT_NONINTERACTIVE=1 show_current_config
        exit 0
        ;;
esac

# Run main if not sourced
if [ "${0##*/}" = "configure-mgmt" ]; then
    main "$@"
fi
