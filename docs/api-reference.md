# API Reference

Base URL: `https://<mgmt-ip>:443`  
API prefix: `/api/v1`

## OpenAPI Discovery

- Machine-readable contract: `GET /openapi.json`
- Interactive docs UI: `GET /docs`

The static reference in this file is aligned to current runtime endpoints from OpenAPI.

## TLS and Authentication

- HTTPS is required; default certificate is self-signed.
- Use `--insecure` for curl and `verify=False` for Python requests in lab environments.
- Protected endpoints require `Authorization: Bearer <accessToken>`.

JWT lifecycle:

1. Call `POST /api/v1/auth/login` to obtain `{ accessToken, refreshToken }`.
2. Use access token for protected API calls.
3. Call `POST /api/v1/auth/refresh` to mint a new access token.
4. Call `POST /api/v1/auth/logout` and discard client-side tokens.

## Envelope and Error Conventions

Success responses use:

```json
{
  "data": {},
  "meta": {}
}
```

Application-level errors use RFC 7807 style payloads under `detail`:

```json
{
  "detail": {
    "type": "about:blank",
    "title": "Validation Error",
    "status": 422,
    "detail": "Human-readable message",
    "instance": "/api/v1/example"
  }
}
```

Validation errors generated by FastAPI/Pydantic (for example, missing required body fields)
use the framework default 422 shape:

```json
{
  "detail": [
    {
      "type": "missing",
      "loc": ["body", "username"],
      "msg": "Field required"
    }
  ]
}
```

## Endpoint Index

### Auth

- `POST /api/v1/auth/login` (public)
- `POST /api/v1/auth/refresh` (public)
- `POST /api/v1/auth/logout` (protected)
- `POST /api/v1/auth/change-password` (protected)
- `GET /api/v1/auth/me` (protected)

### System

- `GET /api/v1/system/health` (protected)
- `GET /api/v1/system/isolation-status` (protected)

### Interfaces

- `GET /api/v1/interfaces` (protected)
- `GET /api/v1/interfaces/{name}` (protected)
- `POST /api/v1/interfaces/{name}/configure` (protected)

### Peers

- `POST /api/v1/peers` (protected)
- `GET /api/v1/peers` (protected)
- `GET /api/v1/peers/{peer_id}` (protected)
- `PUT /api/v1/peers/{peer_id}` (protected)
- `DELETE /api/v1/peers/{peer_id}` (protected)
- `POST /api/v1/peers/{peer_id}/initiate` (protected)

### Routes

- `POST /api/v1/routes` (protected)
- `GET /api/v1/routes` (protected, optional `peerId` query filter)
- `GET /api/v1/routes/{route_id}` (protected)
- `PUT /api/v1/routes/{route_id}` (protected)
- `DELETE /api/v1/routes/{route_id}` (protected)

### Monitoring REST

- `GET /api/v1/monitoring/tunnels` (protected)
- `GET /api/v1/monitoring/interfaces` (protected)

### Monitoring WebSocket

- `WS /api/v1/ws?token=<accessToken>`
- Event envelopes follow `{ type, data }`.

## Request/Response Examples

### Login

```bash
curl -X POST "https://<mgmt-ip>:443/api/v1/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"changeme"}' \
  --insecure
```

```json
{
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiIs...",
    "refreshToken": "eyJhbGciOiJIUzI1NiIs...",
    "tokenType": "bearer"
  },
  "meta": {
    "timestamp": "2026-02-06T15:00:00+00:00"
  }
}
```

### Configure Interface

```bash
curl -X POST "https://<mgmt-ip>:443/api/v1/interfaces/MGMT/configure" \
  -H "Authorization: Bearer <accessToken>" \
  -H "Content-Type: application/json" \
  -d '{"ipAddress":"192.168.10.20","netmask":"255.255.255.0","gateway":"192.168.10.1"}' \
  --insecure
```

### Create Peer

```bash
curl -X POST "https://<mgmt-ip>:443/api/v1/peers" \
  -H "Authorization: Bearer <accessToken>" \
  -H "Content-Type: application/json" \
  -d '{"name":"branch-a","remoteIp":"198.51.100.10","psk":"supersecret","ikeVersion":"ikev2","enabled":true,"dpdAction":"restart","dpdDelay":30,"dpdTimeout":150,"rekeyTime":3600}' \
  --insecure
```

### Create Route

```bash
curl -X POST "https://<mgmt-ip>:443/api/v1/routes" \
  -H "Authorization: Bearer <accessToken>" \
  -H "Content-Type: application/json" \
  -d '{"peerId":1,"destinationCidr":"10.20.0.0/16"}' \
  --insecure
```

### Monitoring REST

```bash
curl -X GET "https://<mgmt-ip>:443/api/v1/monitoring/tunnels" \
  -H "Authorization: Bearer <accessToken>" \
  --insecure
```

### Monitoring WebSocket

```javascript
const ws = new WebSocket("wss://<mgmt-ip>:443/api/v1/ws?token=<accessToken>");
```

Example event:

```json
{
  "type": "tunnel.status_changed",
  "data": {
    "peerId": 1,
    "peerName": "branch-a",
    "status": "up",
    "establishedSec": 420,
    "bytesIn": 2048,
    "bytesOut": 4096,
    "packetsIn": 22,
    "packetsOut": 19,
    "isPassingTraffic": true,
    "lastTrafficAt": "2026-02-06T14:59:10+00:00",
    "timestamp": "2026-02-06T15:00:00+00:00"
  }
}
```

## Example Automation Assets

- `examples/curl_examples.sh`
- `examples/python_api_client.py`

Both examples use the same authentication and endpoint patterns documented above.
